<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Document Upload</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f9f9f9;
        }
        .upload-area.dragover {
            border-color: #4CAF50;
            background: #f0f8ff;
        }
        input[type="file"] {
            display: none;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .file-info {
            margin: 20px 0;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üß™ Test Document Upload</h1>
    <p>This page tests document upload directly to your production Supabase instance.</p>
    
    <div class="upload-area" id="uploadArea">
        <p>üìÅ Drag & drop a file here or click to browse</p>
        <input type="file" id="fileInput" accept="*/*">
        <button onclick="document.getElementById('fileInput').click()">Choose File</button>
    </div>
    
    <div id="fileInfo"></div>
    
    <button id="uploadBtn" style="display:none;" onclick="uploadFile()">
        Upload to Supabase
    </button>
    
    <div id="status"></div>
    
    <h3>Test Results:</h3>
    <pre id="results"></pre>

    <script>
        let selectedFile = null;
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3004' 
            : 'https://appboardguru.vercel.app';
        
        // File input handler
        document.getElementById('fileInput').addEventListener('change', (e) => {
            handleFileSelect(e.target.files[0]);
        });
        
        // Drag and drop handlers
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            if (!file) return;
            
            selectedFile = file;
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <div class="file-info">
                    <h3>Selected File:</h3>
                    <p><strong>Name:</strong> ${file.name}</p>
                    <p><strong>Type:</strong> ${file.type || 'unknown'}</p>
                    <p><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    <p><strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleString()}</p>
                </div>
            `;
            
            document.getElementById('uploadBtn').style.display = 'inline-block';
            updateStatus('info', 'File selected. Click "Upload to Supabase" to proceed.');
        }
        
        async function uploadFile() {
            if (!selectedFile) {
                updateStatus('error', 'No file selected');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="loading"></span> Uploading...';
            
            updateStatus('info', 'Starting upload...');
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            try {
                // Test with our simplified endpoint
                updateStatus('info', 'Uploading to test endpoint...');
                
                const response = await fetch(`${API_URL}/api/test-upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    updateStatus('success', '‚úÖ Upload successful!');
                    updateResults({
                        success: true,
                        assetId: result.asset?.id,
                        fileName: result.asset?.file_name,
                        filePath: result.asset?.file_path,
                        message: result.message
                    });
                } else {
                    updateStatus('error', `‚ùå Upload failed: ${result.error}`);
                    updateResults({
                        success: false,
                        error: result.error,
                        details: result.details,
                        code: result.code,
                        hint: result.hint,
                        step: result.step
                    });
                }
                
            } catch (error) {
                updateStatus('error', `‚ùå Network error: ${error.message}`);
                updateResults({
                    success: false,
                    error: error.message,
                    type: 'network_error'
                });
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'Upload to Supabase';
            }
        }
        
        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        function updateResults(data) {
            const results = document.getElementById('results');
            results.textContent = JSON.stringify(data, null, 2);
            
            if (!data.success) {
                // Add diagnostic information
                const diagnostics = {
                    ...data,
                    diagnostics: {
                        api_url: API_URL,
                        file_name: selectedFile?.name,
                        file_size: selectedFile?.size,
                        file_type: selectedFile?.type,
                        timestamp: new Date().toISOString()
                    }
                };
                results.textContent = JSON.stringify(diagnostics, null, 2);
            }
        }
        
        // Check if API is reachable
        fetch(`${API_URL}/api/test-upload`)
            .then(r => r.json())
            .then(data => {
                console.log('API endpoint ready:', data);
                updateStatus('info', '‚úÖ API endpoint is reachable. You can upload a file.');
            })
            .catch(err => {
                console.error('API not reachable:', err);
                updateStatus('error', `‚ö†Ô∏è Cannot reach API at ${API_URL}. Check if the server is running.`);
            });
    </script>
</body>
</html>